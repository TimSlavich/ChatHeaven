from langchain_openai import ChatOpenAI
from langchain.agents import create_openai_functions_agent, AgentExecutor
from langchain_community.vectorstores.faiss import FAISS
from langchain.prompts import MessagesPlaceholder
from langchain.prompts import ChatPromptTemplate
from app.utils.vector_search import vector_search


def create_agent(vector_store: FAISS) -> AgentExecutor:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.

    :param vector_store: –û–±—ä–µ–∫—Ç FAISS –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º.
    :return: –ê–≥–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
    """
    llm = ChatOpenAI(
        model="gpt-4o",
        temperature=0.9,
    )

    tools = [vector_search(vector_store)]

    prompt = ChatPromptTemplate.from_messages(
        [
            (
                "system",
                "–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∏–º–µ–Ω–∏ –í–ª–∞–¥ –ö–æ–≤–∞–ª—å—Å—å–∫–∏–π. –û—Ç–≤–µ—á–∞–π **—á–µ—Ç–∫–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ** üòä. "
                "–§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É—è **Markdown**, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ —É–¥–æ–±–Ω—ã –¥–ª—è —á—Ç–µ–Ω–∏—è.\n\n"
                "### üîπ **–ö–∞–∫ –æ—Ñ–æ—Ä–º–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã:**\n"
                "- **–í—ã–¥–µ–ª—è–π –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã** –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º.\n"
                "- –ò—Å–ø–æ–ª—å–∑—É–π `–∫–æ–¥ –≤ —Å—Ç—Ä–æ–∫–µ`, –µ—Å–ª–∏ –¥–∞–µ—à—å –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞.\n"
                "- **–†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏** –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è.\n"
                "- **–î–ª—è –ø–æ—à–∞–≥–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (1, 2, 3...)**.\n"
                "- **–î–æ–±–∞–≤–ª—è–π —Å–º–∞–π–ª–∏–∫–∏**, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ (üòä, üöÄ, üî•).\n\n"
                "### üîπ **–ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**\n"
                "**üìå –û–±—â–µ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:**\n"
                "–û–ø–∏—à–∏ —Ç–µ–º—É –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ, –≤—ã–¥–µ–ª—è—è –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã **–∂–∏—Ä–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º**.\n\n"
                "**üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:**\n"
                "1. –û–ø–∏—Å—ã–≤–∞–π –∫–∞–∂–¥—ã–π —à–∞–≥ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.\n"
                "2. –ò—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.\n"
                "3. –ï—Å–ª–∏ —ç—Ç–æ —Å–ø–∏—Å–æ–∫, –¥–æ–±–∞–≤–ª—è–π –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –ø—É–Ω–∫—Ç–∞–º–∏.\n\n"
                "**üíª –ö–æ–¥–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã:**\n"
                "```python\n"
                "def example():\n"
                "    print('–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞')\n"
                "```\n\n"
                "–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è ‚Äì **–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π**. –ù–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—á–∞–ª–µ –æ–±—â–µ–Ω–∏—è!",
            ),
            MessagesPlaceholder(variable_name="chat_history"),
            ("human", "{input}"),
            MessagesPlaceholder(variable_name="agent_scratchpad"),
        ]
    )

    agent = create_openai_functions_agent(
        llm=llm,
        prompt=prompt,
        tools=tools,
    )

    agentExecutor = AgentExecutor(
        agent=agent,
        tools=tools,
    )

    return agentExecutor
